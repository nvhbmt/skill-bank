---
// This page handles OAuth callback with hash fragment
// It reads the hash fragment client-side and sends it to the server
import { getStaticPaths, useTranslate } from '@/i18n';
export { getStaticPaths };

const { lang, t, l } = useTranslate(Astro);
---

<!doctype html>
<html lang={lang}>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Đang xử lý đăng nhập...</title>
    </head>
    <body>
        <div
            style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); color: white; font-family: system-ui;"
        >
            <div style="text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 1rem;">⏳</div>
                <div>Đang xử lý đăng nhập...</div>
            </div>
        </div>

        <script>
            (function () {
                // Read hash fragment
                const hash = window.location.hash.substring(1);
                const hashParams = new URLSearchParams(hash);

                const accessToken = hashParams.get('access_token');
                const refreshToken = hashParams.get('refresh_token');
                const error = hashParams.get('error');
                const errorDescription = hashParams.get('error_description');

                const currentLang =
                    window.location.pathname.split('/')[1] || 'vi';

                if (error) {
                    console.error('OAuth error:', error, errorDescription);
                    window.location.href = `/${currentLang}/sign-in?error=oauth_failed`;
                    return;
                }

                if (!accessToken) {
                    console.error('No access token found');
                    window.location.href = `/${currentLang}/sign-in?error=no_token`;
                    return;
                }

                // Send token to server to create session
                fetch('/api/auth/oauth-callback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        access_token: accessToken,
                        refresh_token: refreshToken,
                    }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            // Redirect to home page
                            window.location.href = `/${currentLang}/`;
                        } else {
                            console.error(
                                'Error processing OAuth:',
                                data.message
                            );
                            window.location.href = `/${currentLang}/sign-in?error=processing_failed`;
                        }
                    })
                    .catch((error) => {
                        console.error('Error sending token to server:', error);
                        window.location.href = `/${currentLang}/sign-in?error=server_error`;
                    });
            })();
        </script>
    </body>
</html>
