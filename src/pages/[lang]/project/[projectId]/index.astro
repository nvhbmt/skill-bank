---
import DefaultLayout from '@/layouts/DefaultLayout.astro';
import Header from '@/components/Header.astro';
import ConfirmDialog from '@/components/ConfirmDialog.astro';
import ShareDialog from '@/components/ShareDialog.astro';
import '@/assets/css/project.css';
import { getStaticPaths, useTranslate } from '@/i18n';
import { getProjectDetailById } from '@/services/project-detail';
export { getStaticPaths };

const session = Astro.locals.session;
const { lang, t, l } = useTranslate(Astro);
const projectId = (Astro.params as { projectId?: string }).projectId;

// Fetch project data
if (!projectId) {
    return Astro.redirect(l(`/explore`));
}

const projectIdNum = parseInt(projectId);
if (isNaN(projectIdNum)) {
    return Astro.redirect(l(`/explore`));
}

const projectData = await getProjectDetailById(projectIdNum, session?.user?.id);

if (!projectData || !projectData.project) {
    return Astro.redirect(l(`/explore`));
}

const {
    project,
    owner,
    projectSkills,
    members,
    milestones,
    isOwner,
    isMember,
} = projectData;

// Format date helper
function formatDate(dateString: string | null): string {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
        });
    } catch {
        return dateString;
    }
}
---

<DefaultLayout>
    <div class="wrapper">
        <Header />

        <main>
            <div class="project-detail-container">
                <div class="project-detail-body">
                    <!-- CỘT TRÁI: THÔNG TIN CHÍNH -->
                    <div class="column-main">
                        <!-- Phần Header -->
                        <div class="project-top-section">
                            <div class="project-info">
                                <h1 class="project-title">
                                    {
                                        project?.title ||
                                            t(
                                                'project-detail-collab.projectTitle'
                                            )
                                    }
                                </h1>

                                <div class="project-meta-list">
                                    <div class="meta-row">
                                        <span class="meta-label">
                                            {
                                                t(
                                                    'project-detail-collab.ngayBatDau'
                                                )
                                            }
                                        </span>
                                        <span class="meta-value">
                                            {
                                                project?.start_date
                                                    ? formatDate(
                                                          project.start_date
                                                      )
                                                    : '-'
                                            }
                                        </span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label">
                                            {
                                                t(
                                                    'project-detail-collab.phanLoai'
                                                )
                                            }
                                        </span>
                                        <span class="meta-value">
                                            {project?.project_type || '-'}
                                        </span>
                                    </div>
                                    <div class="meta-row">
                                        <span class="meta-label">
                                            {t('project-detail-collab.điaDiem')}
                                        </span>
                                        <span class="meta-value">
                                            {project?.location || '-'}
                                        </span>
                                    </div>
                                </div>

                                <!-- CẬP NHẬT: Người đăng Profile Card -->
                                {
                                    owner && (
                                        <a
                                            href={l(
                                                `/profile/${owner.username}`
                                            )}
                                            class="creator-profile-card"
                                        >
                                            <div class="creator-avatar-wrapper">
                                                <img
                                                    src={
                                                        owner.avatar_url ||
                                                        '/assets/images/avatar-default-icon.png'
                                                    }
                                                    alt={t(
                                                        'project-detail-collab.creator'
                                                    )}
                                                />
                                                <span class="creator-badge-icon">
                                                    <i class="fa-solid fa-crown" />
                                                </span>
                                            </div>
                                            <div class="creator-text-info">
                                                <span class="creator-name">
                                                    {owner.full_name ||
                                                        owner.username}
                                                </span>
                                                <span class="creator-username">
                                                    @{owner.username}
                                                </span>
                                            </div>
                                        </a>
                                    )
                                }

                                <!-- CẬP NHẬT: Nút bấm UX đẹp -->
                            </div>

                            <!-- Ảnh dự án -->
                            {
                                project?.cover_image_url && (
                                    <div class="project-image-wrapper">
                                        <img
                                            src={project.cover_image_url}
                                            alt={t(
                                                'project-detail-collab.projectCover'
                                            )}
                                            class="project-image"
                                        />
                                    </div>
                                )
                            }
                        </div>
                        <div class="action-buttons">
                            <!-- Nút "Xem bàn giao" - chỉ hiện cho owner -->
                            {
                                isOwner && (
                                    <button class="action-btn btn-view-handover">
                                        <i class="fa-solid fa-file-import" />
                                        {t('project-detail-creator.xemBanGiao')}
                                    </button>
                                )
                            }
                            <!-- Nút "Bàn giao" - chỉ hiện cho member (không phải owner) -->
                            {
                                isMember && !isOwner && (
                                    <button class="action-btn btn-view-handover">
                                        <i class="fa-solid fa-file-import" />
                                        {t('project-detail-collab.banGiao')}
                                    </button>
                                )
                            }
                            <!-- Nút "Share" - hiện cho tất cả -->
                            <button
                                class="action-btn btn-share-project"
                                id="share-project-btn"
                                data-project-id={project?.id}
                            >
                                <i class="fa-solid fa-share"></i>
                                {t('project-detail-collab.share')}
                            </button>
                            <!-- Nút "Xóa dự án" - chỉ hiện cho owner -->
                            {
                                isOwner && (
                                    <button
                                        class="action-btn btn-delete-project"
                                        id="delete-project-btn"
                                        data-project-id={project?.id}
                                        data-project-title={
                                            project?.title || ''
                                        }
                                    >
                                        <i class="fa-solid fa-x" />
                                        {t('project-detail-creator.xoaDuAn')}
                                    </button>
                                )
                            }
                        </div>
                        <!-- Phần Mô tả -->
                        {
                            project?.description && (
                                <div class="description-box">
                                    <div class="box-header">
                                        <i class="fa-solid fa-caret-down" />
                                        <h3>
                                            {t('project-detail-collab.moTa')}
                                        </h3>
                                    </div>
                                    <div class="box-content">
                                        <p>{project.description}</p>
                                    </div>
                                </div>
                            )
                        }

                        <!-- Phần Kỹ năng -->
                        {
                            projectSkills.length > 0 && (
                                <div class="skills-section">
                                    <h3>
                                        {t('project-detail-collab.danhMucKN')}
                                    </h3>
                                    <div class="skills-list">
                                        {projectSkills.map((skill, index) => (
                                            <div class="skill-item-view">
                                                <span class="skill-label">
                                                    {t(
                                                        'project-detail-collab.KN'
                                                    )}{' '}
                                                    {index + 1}
                                                </span>
                                                <div class="skill-content">
                                                    <div class="skill-tag">
                                                        {skill.name}
                                                        {skill.category
                                                            ? ` / ${skill.category}`
                                                            : ''}
                                                    </div>
                                                    {!isOwner && !isMember && (
                                                        <a
                                                            href={l(
                                                                `/submit-application/${project?.id}`
                                                            )}
                                                            class="btn-skill-detail"
                                                            title={t(
                                                                'project-detail-collab.viewDetails'
                                                            )}
                                                        >
                                                            <span>
                                                                {t(
                                                                    'project-detail-collab.ungTuyen'
                                                                )}
                                                            </span>
                                                        </a>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )
                        }
                    </div>

                    <!-- CỘT PHẢI: SIDEBAR -->
                    <div class="column-sidebar">
                        <!-- Hoạt động biểu (Timeline) -->
                        {
                            milestones.length > 0 && (
                                <div class="sidebar-section timeline-section">
                                    <h3>
                                        {t(
                                            'project-detail-collab.activityChart'
                                        )}
                                    </h3>
                                    <div class="timeline-cards">
                                        {milestones.map((milestone) => (
                                            <div class="timeline-card">
                                                {milestone.title}
                                                {milestone.description
                                                    ? `: ${milestone.description}`
                                                    : ''}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )
                        }

                        <!-- Thành viên -->
                        {
                            members.length > 0 && (
                                <div class="sidebar-section members-section">
                                    <h3>
                                        {t('project-detail-collab.Members')}
                                    </h3>
                                    <div class="members-list">
                                        {members.map((member) => (
                                            <a
                                                href={l(
                                                    `/profile/${member.username}`
                                                )}
                                                class="member-card"
                                            >
                                                <img
                                                    src={
                                                        member.avatar_url ||
                                                        '/assets/images/avatar-default-icon.png'
                                                    }
                                                    alt={t(
                                                        'project-detail-collab.avatar'
                                                    )}
                                                    class="member-avatar"
                                                />
                                                <div class="member-info">
                                                    <span class="name">
                                                        {member.full_name ||
                                                            member.username}
                                                    </span>
                                                    <span class="username">
                                                        @{member.username}
                                                    </span>
                                                </div>
                                            </a>
                                        ))}
                                    </div>
                                </div>
                            )
                        }
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirm Delete Dialog -->
    <ConfirmDialog
        id="delete-project-dialog"
        titleId="delete-project-dialog-title"
        messageId="delete-project-dialog-message"
        confirmButtonId="delete-project-dialog-confirm"
        cancelButtonId="delete-project-dialog-cancel"
        confirmText={t('project-detail-creator.confirmDeleteButton')}
        cancelText={t('project-detail-creator.cancelButton')}
    />

    <!-- Share Dialog -->
    <ShareDialog
        id="share-project-dialog"
        titleId="share-project-dialog-title"
        linkInputId="share-project-dialog-link-input"
        copyButtonId="share-project-dialog-copy-button"
        closeButtonId="share-project-dialog-close"
        title={t('project-detail-creator.shareTitle')}
        linkLabel={t('project-detail-creator.shareLinkLabel')}
        copyButtonText={t('project-detail-creator.copyButton')}
        copiedButtonText={t('project-detail-creator.copiedButton')}
        closeButtonText={t('project-detail-creator.closeButton')}
    />
</DefaultLayout>

<script
    define:vars={{
        projectId: project?.id || 0,
        projectTitle: project?.title || '',
        lang: lang,
        confirmDeleteTitle: t('project-detail-creator.confirmDeleteTitle'),
        confirmDeleteMessage: t('project-detail-creator.confirmDeleteMessage'),
    }}
>
    (function () {
        // Delete button handler
        const deleteBtn = document.getElementById('delete-project-btn');

        if (deleteBtn) {
            deleteBtn.addEventListener('click', function () {
                // Replace {{projectTitle}} in message
                const message = confirmDeleteMessage.replace(
                    '{{projectTitle}}',
                    projectTitle
                );

                // Open confirm dialog
                if (window.openDeleteProjectDialog) {
                    window.openDeleteProjectDialog(
                        confirmDeleteTitle,
                        message,
                        async function () {
                            // Handle delete
                            try {
                                const response = await fetch(
                                    `/api/projects/${projectId}/delete`,
                                    {
                                        method: 'DELETE',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                    }
                                );

                                const result = await response.json();
                                if (result.success) {
                                    // Redirect to my projects page
                                    window.location.href = `/${lang}/my-project`;
                                } else {
                                    alert(
                                        result.message ||
                                            'Có lỗi xảy ra khi xóa dự án'
                                    );
                                }
                            } catch (error) {
                                console.error('Error deleting project:', error);
                                alert('Có lỗi xảy ra khi xóa dự án');
                            }
                        }
                    );
                }
            });
        }

        // Share button handler
        const shareBtn = document.getElementById('share-project-btn');

        if (shareBtn) {
            shareBtn.addEventListener('click', function () {
                // Get current URL
                const currentUrl = window.location.href;

                // Open share dialog
                if (window.openShareProjectDialog) {
                    window.openShareProjectDialog(currentUrl);
                }
            });
        }
    })();
</script>
