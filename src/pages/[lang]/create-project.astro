---
import '@/assets/css/create-project.css';
import Header from '@/components/Header.astro';
import { getStaticPaths, useTranslate } from '@/i18n';
import DefaultLayout from '@/layouts/DefaultLayout.astro';
import { supabase } from '@/lib/supabase';
export { getStaticPaths };

const { lang, t, l } = useTranslate(Astro);
const session = Astro.locals.session;
if (!session?.user) {
    return Astro.redirect(`/${lang}/sign-in`);
}

// Load skills from database
let skills: Array<{ id: number; name: string }> = [];
try {
    const { data, error } = await supabase
        .from('skills')
        .select('id, name')
        .order('name', { ascending: true });

    if (!error && data) {
        skills = data;
    } else {
        console.error('Error loading skills:', error);
    }
} catch (error) {
    console.error('Error loading skills:', error);
}
---

<DefaultLayout>
    <div class="wrapper">
        <Header />

        <main>
            <div class="hero-section">
                <h1>{t('create-project.title')}</h1>

                <form class="project-form" id="project-form">
                    <div class="form-body">
                        <div class="column-left">
                            <section class="form-section" id="thong-tin-chung">
                                <h3>{t('create-project.thongTinChung')}</h3>
                                <div class="form-group-wrapper-1 group-left">
                                    <div class="sub-grid-1">
                                        <div class="form-group">
                                            <label for="project-name"
                                                >{
                                                    t('create-project.tenDuAn')
                                                }</label
                                            >
                                            <input
                                                type="text"
                                                id="project-name"
                                                name="project_name"
                                                class="form-input"
                                            />
                                        </div>
                                        <div class="form-group">
                                            <label for="location"
                                                >{
                                                    t('create-project.điaDiem')
                                                }</label
                                            >
                                            <input
                                                type="text"
                                                id="location"
                                                name="location"
                                                class="form-input"
                                            />
                                        </div>
                                    </div>

                                    <div class="sub-grid-2">
                                        <div class="form-group">
                                            <label for="category"
                                                >{
                                                    t('create-project.phanLoai')
                                                }</label
                                            >
                                            <select
                                                id="category"
                                                name="category"
                                                class="form-input"
                                                required
                                            >
                                                <option
                                                    value=""
                                                    disabled
                                                    selected
                                                    hidden
                                                    >{
                                                        t(
                                                            'create-project.chonPhanLoai'
                                                        )
                                                    }</option
                                                >
                                                <option value="website"
                                                    >Website</option
                                                >
                                                <option value="mobile-app"
                                                    >Mobile App</option
                                                >
                                                <option value="desktop-app"
                                                    >Desktop App</option
                                                >
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="start-date"
                                                >{
                                                    t('create-project.tgianBD')
                                                }</label
                                            >
                                            <input
                                                type="date"
                                                id="start-date"
                                                name="start_date"
                                                class="form-input"
                                                required
                                            />
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section class="form-section" id="mo-ta-du-an">
                                <h3>{t('create-project.moTa')}</h3>
                                <div class="form-group group-left">
                                    <textarea
                                        id="description"
                                        name="description"
                                        class="form-input auto-resize-textarea"
                                        rows="4"
                                        placeholder={t(
                                            'create-project.moTaChiTiet'
                                        )}></textarea>
                                </div>
                            </section>

                            <section class="form-section" id="ky-nang">
                                <h3
                                    class="section-title-with-button section-title-with-button-kn"
                                >
                                    <span>{t('create-project.danhMucKN')}</span>
                                    <button
                                        type="button"
                                        class="btn-add"
                                        id="add-skill-btn">+</button
                                    >
                                </h3>
                                <div
                                    class="form-group-wrapper-2 group-left"
                                    id="skill-list-container"
                                >
                                    <!-- Item kỹ năng mẫu -->
                                    <div class="skill-item">
                                        <div class="form-group">
                                            <!-- CẬP NHẬT: Wrapper mới cho Label để chứa nút xóa -->
                                            <div class="skill-label-wrapper">
                                                <label for="skill-1"
                                                    >{
                                                        t('create-project.KN1')
                                                    }</label
                                                >
                                                <!-- Nút xóa sẽ được JS thêm vào đây -->
                                            </div>

                                            <!-- Wrapper flex cho Select và Nút Chi tiết -->
                                            <div class="skill-controls">
                                                <select
                                                    id="skill-1"
                                                    name="skill-1"
                                                    class="form-input skill-select"
                                                    required
                                                >
                                                    <option
                                                        value=""
                                                        disabled
                                                        hidden
                                                        selected
                                                        >{
                                                            t(
                                                                'create-project.chonKN'
                                                            )
                                                        }</option
                                                    >
                                                    {
                                                        skills.map((skill) => (
                                                            <option
                                                                value={skill.name.toLowerCase()}
                                                            >
                                                                {skill.name}
                                                            </option>
                                                        ))
                                                    }
                                                </select>

                                                <!-- Nút "Chi tiết" -->
                                                <button
                                                    type="button"
                                                    class="btn-skill-detail"
                                                    title="Thêm chi tiết cho kỹ năng này"
                                                >
                                                    <span
                                                        >{
                                                            t(
                                                                'create-project.chiTiet'
                                                            )
                                                        }</span
                                                    >
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            <section class="form-section">
                                <h3>{t('create-project.taiLenAnhBia')}</h3>
                                <div
                                    class="form-group group-left upload-container"
                                >
                                    <label class="upload-box" for="coverUpload">
                                        <i
                                            class="fa-solid fa-arrow-up-from-bracket"
                                        ></i>
                                        <p>{t('create-project.dangTaiODay')}</p>
                                    </label>

                                    <input
                                        type="file"
                                        id="coverUpload"
                                        name="cover_image"
                                        accept="image/*"
                                        hidden
                                    />

                                    <!-- Preview ảnh -->
                                    <div
                                        id="cover-preview"
                                        class="cover-preview"
                                        hidden
                                    >
                                        <img
                                            id="cover-preview-img"
                                            src=""
                                            alt="Preview ảnh bìa"
                                            class="cover-preview-image"
                                        />
                                        <button
                                            type="button"
                                            class="btn-remove-cover"
                                            id="btn-remove-cover"
                                            aria-label="Xóa ảnh bìa"
                                        >
                                            ×
                                        </button>
                                    </div>

                                    <!-- Tên file -->
                                    <a
                                        id="cover-file-name"
                                        class="file-name-display"
                                        href="#"
                                        target="_blank"
                                        download
                                        hidden></a>
                                </div>
                            </section>
                        </div>

                        <!-- CỘT BÊN PHẢI -->
                        <div class="column-right">
                            <section class="form-section" id="thoi-gian">
                                <h3 class="section-title-with-button">
                                    <span>{t('create-project.tgianHD')}</span>
                                    <button
                                        type="button"
                                        class="btn-add"
                                        id="add-milestone-btn">+</button
                                    >
                                </h3>

                                <div
                                    class="timeline-container"
                                    id="milestone-list"
                                >
                                    <div class="milestone-item">
                                        <textarea
                                            name="milestone-1"
                                            class="milestone-input auto-resize-textarea"
                                            placeholder={t(
                                                'create-project.moc1'
                                            )}
                                            rows="1"></textarea>
                                    </div>
                                </div>
                            </section>

                            <section class="form-section" id="thanh-vien">
                                <h3>{t('create-project.thanhVien')}</h3>
                                <div class="list-wrapper">
                                    <a href="#" class="member-item">
                                        <img
                                            src="/assets/images/vy2.png"
                                            alt="avatar"
                                            class="member-avatar"
                                        />
                                        <div class="member-info">
                                            <span class="member-name"
                                                >Bùi Thái Vy</span
                                            >
                                            <span class="member-username"
                                                >@vyxam</span
                                            >
                                        </div>
                                    </a>
                                    <a href="#" class="member-item">
                                        <img
                                            src="/assets/images/vy2.png"
                                            alt="avatar"
                                            class="member-avatar"
                                        />
                                        <div class="member-info">
                                            <span class="member-name"
                                                >Nguyễn Xuân Việt Anh</span
                                            >
                                            <span class="member-username"
                                                >@tredeadline</span
                                            >
                                        </div>
                                    </a>
                                    <a href="#" class="member-item">
                                        <img
                                            src="/assets/images/vy2.png"
                                            alt="avatar"
                                            class="member-avatar"
                                        />
                                        <div class="member-info">
                                            <span class="member-name"
                                                >Trần Tường Vân</span
                                            >
                                            <span class="member-username"
                                                >@deptrais1tgioi</span
                                            >
                                        </div>
                                    </a>
                                </div>
                            </section>
                        </div>
                    </div>

                    <div class="form-footer">
                        <div class="checkbox-area">
                            <input
                                type="checkbox"
                                id="terms"
                                name="terms"
                                class="form-checkbox"
                            />
                            <label for="terms"
                                >{t('create-project.toiDongTinh')}<a href="#"
                                    >{t('create-project.chinhSach')}</a
                                ></label
                            >
                        </div>
                        <div class="buttons-area">
                            <button type="button" class="btn btn-secondary"
                                >{t('create-project.quayLai')}</button
                            >
                            <button type="submit" class="btn btn-primary"
                                >{t('create-project.dang')}</button
                            >
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script src="@/assets/script/create-project.js"></script>
</DefaultLayout>
