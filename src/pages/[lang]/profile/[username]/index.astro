---
import DefaultLayout from '@/layouts/DefaultLayout.astro';
import '@/assets/css/personal-profile.css';
import Header from '@/components/Header.astro';
import { getStaticPaths, useTranslate } from '@/i18n';
import { supabase } from '@/lib/supabase';
import type { Tables } from '@/types/database.types';
export { getStaticPaths };

const session = Astro.locals.session;
const { lang, t, l } = useTranslate(Astro);
const username = (Astro.params as { username?: string }).username;

// Initialize data using types from database.types.ts
let userInfo: Tables<'user_info'> | null = null;

let userProfile: Pick<
    Tables<'user_profiles'>,
    | 'phone'
    | 'bio'
    | 'address'
    | 'portfolio_url'
    | 'interests'
    | 'experiences'
    | 'projects'
    | 'certifications'
> | null = null;

let userSkills: Array<
    Pick<Tables<'skills'>, 'id' | 'name' | 'category'> & {
        level: string | null;
    }
> = [];

let userProjects: Array<
    Pick<
        Tables<'projects'>,
        'id' | 'title' | 'cover_image_url' | 'project_type' | 'status'
    >
> = [];

let reviews: Array<
    Pick<
        Tables<'reviews'>,
        'id' | 'rating' | 'comment' | 'reviewer_id' | 'created_at'
    > & {
        reviewer_info: Pick<
            Tables<'user_info'>,
            'full_name' | 'username' | 'avatar_url'
        > | null;
    }
> = [];

let isOwner = false;

// Fetch user data
if (username) {
    try {
        // Fetch user_info
        const { data: userData, error: userError } = await supabase
            .from('user_info')
            .select('*')
            .eq('username', username)
            .is('deleted_at', null)
            .single();

        if (!userError && userData) {
            userInfo = userData;

            // Check if current user is owner
            if (session?.user) {
                isOwner = session.user.id === userInfo.user_id;
            }

            // Fetch user_profiles
            const { data: profileData, error: profileError } = await supabase
                .from('user_profiles')
                .select(
                    'phone, bio, address, portfolio_url, interests, experiences, projects, certifications'
                )
                .eq('user_id', userInfo.user_id)
                .is('deleted_at', null)
                .maybeSingle();

            if (!profileError && profileData) {
                userProfile = profileData;
            }

            // Fetch user_skills
            const { data: userSkillsData, error: skillsError } = await supabase
                .from('user_skills')
                .select('skill_id, level')
                .eq('user_id', userInfo.user_id)
                .is('deleted_at', null);

            if (!skillsError && userSkillsData && userSkillsData.length > 0) {
                const skillIds = userSkillsData.map((us) => us.skill_id);
                const { data: skillsData, error: skillsDataError } =
                    await supabase
                        .from('skills')
                        .select('id, name, category')
                        .in('id', skillIds);

                if (!skillsDataError && skillsData) {
                    const skillsMap = new Map(
                        userSkillsData.map((us) => [us.skill_id, us.level])
                    );
                    userSkills = skillsData.map((skill) => ({
                        ...skill,
                        level: skillsMap.get(skill.id) || null,
                    }));
                }
            }

            // Fetch user projects (as owner)
            const { data: projectsData, error: projectsError } = await supabase
                .from('projects')
                .select('id, title, cover_image_url, project_type, status')
                .eq('owner_id', userInfo.user_id)
                .is('deleted_at', null)
                .order('created_at', { ascending: false })
                .limit(10);

            if (!projectsError && projectsData) {
                userProjects = projectsData;
            }

            // Fetch reviews for this user
            const { data: reviewsData, error: reviewsError } = await supabase
                .from('reviews')
                .select('id, rating, comment, reviewer_id, created_at')
                .eq('reviewee_id', userInfo.user_id)
                .is('deleted_at', null)
                .order('created_at', { ascending: false })
                .limit(10);

            if (!reviewsError && reviewsData && reviewsData.length > 0) {
                const reviewerIds = reviewsData.map((r) => r.reviewer_id);
                const { data: reviewersData, error: reviewersError } =
                    await supabase
                        .from('user_info')
                        .select('user_id, full_name, username, avatar_url')
                        .in('user_id', reviewerIds)
                        .is('deleted_at', null);

                if (!reviewersError && reviewersData) {
                    const reviewersMap = new Map(
                        reviewersData.map((r) => [r.user_id, r])
                    );
                    reviews = reviewsData.map((review) => ({
                        ...review,
                        reviewer_info:
                            reviewersMap.get(review.reviewer_id) || null,
                    }));
                }
            }
        } else {
            // User not found, redirect
            return Astro.redirect(`/${lang}/project-search`);
        }
    } catch (error) {
        console.error('Error loading user profile:', error);
        return Astro.redirect(`/${lang}/project-search`);
    }
} else {
    // No username, redirect
    return Astro.redirect(`/${lang}/project-search`);
}

// Helper function to get star count
function getStarCount(rating: number | null): {
    full: number;
    hasHalf: boolean;
} {
    if (!rating) return { full: 0, hasHalf: false };
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    return { full: fullStars, hasHalf: hasHalfStar };
}
---

<DefaultLayout>
    <div class="wrapper">
        <Header />

        <main>
            <div class="profile-container">
                <!-- === CỘT TRÁI: SIDEBAR === -->
                <div class="left-sidebar">
                    <!-- 1. User Card -->
                    <div class="sidebar-card user-card">
                        <div class="user-avatar-wrapper">
                            <img
                                src={
                                    userInfo?.avatar_url ||
                                    '/assets/images/vy2.png'
                                }
                                alt={`Avatar của ${userInfo?.full_name || userInfo?.username || 'User'}`}
                                class="user-avatar"
                            />
                        </div>
                        <div class="user-info">
                            <h3>
                                {userInfo?.full_name ||
                                    userInfo?.username ||
                                    'User'}
                            </h3>
                            <span>@{userInfo?.username || 'username'}</span>
                        </div>
                    </div>

                    <!-- 2. Thông tin chung -->
                    <div class="sidebar-card section-card">
                        <h4>{t('profile.thongTinChung')}</h4>
                        <div class="info-list">
                            {userProfile?.phone && (
                                <div class="info-item">
                                    <span class="info-label">
                                        {t('profile.soDienThoai')}:
                                    </span>
                                    <span class="info-value">
                                        {userProfile.phone}
                                    </span>
                                </div>
                            )}
                            {userInfo?.email && (
                                <div class="info-item">
                                    <span class="info-label">
                                        {t('profile.email')}:
                                    </span>
                                    <span class="info-value">
                                        {userInfo.email}
                                    </span>
                                </div>
                            )}
                        </div>
                    </div>

                    <!-- 3. Thông tin thêm -->
                    {(userProfile?.address ||
                        userProfile?.interests ||
                        userProfile?.experiences) && (
                        <div class="sidebar-card section-card">
                            <h4>{t('profile.thongTinThem')}</h4>
                            <div class="info-list">
                                {userProfile?.address && (
                                    <div class="info-item">
                                        <span class="info-label">Địa chỉ:</span>
                                        <span class="info-value">
                                            {userProfile.address}
                                        </span>
                                    </div>
                                )}
                                {userProfile?.interests && (
                                    <div class="info-item">
                                        <span class="info-label">
                                            {t('profile.linhVucQuanTam')}:
                                        </span>
                                        <ul class="bullet-list">
                                            {(() => {
                                                try {
                                                    const interests = JSON.parse(
                                                        userProfile.interests
                                                    );
                                                    return Array.isArray(
                                                        interests
                                                    )
                                                        ? interests
                                                        : [];
                                                } catch {
                                                    return [];
                                                }
                                            })().map(
                                                (interest: string) => (
                                                    <li>{interest}</li>
                                                )
                                            )}
                                        </ul>
                                    </div>
                                )}
                                {userProfile?.experiences && (
                                    <div class="info-item" style="margin-top: 1rem;">
                                        <span class="info-label">
                                            {t('profile.kinhNghiem')}:
                                        </span>
                                        <ul class="bullet-list">
                                            {(() => {
                                                try {
                                                    const experiences = JSON.parse(
                                                        userProfile.experiences
                                                    );
                                                    return Array.isArray(
                                                        experiences
                                                    )
                                                        ? experiences
                                                        : [];
                                                } catch {
                                                    return [];
                                                }
                                            })().map(
                                                (experience: string) => (
                                                    <li>{experience}</li>
                                                )
                                            )}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    <!-- 4. Thành tựu -->
                    {(userProfile?.projects ||
                        userProfile?.certifications) && (
                        <div class="sidebar-card section-card">
                            <h4>{t('profile.thanhTuu')}</h4>
                            <div class="info-list">
                                {userProfile?.projects && (
                                    <div class="info-item">
                                        <span class="info-label">
                                            {t('profile.duAnTungLam')}:
                                        </span>
                                        <ul class="bullet-list">
                                            {(() => {
                                                try {
                                                    const projects = JSON.parse(
                                                        userProfile.projects
                                                    );
                                                    return Array.isArray(
                                                        projects
                                                    )
                                                        ? projects
                                                        : [];
                                                } catch {
                                                    return [];
                                                }
                                            })().map(
                                                (project: string) => (
                                                    <li>{project}</li>
                                                )
                                            )}
                                        </ul>
                                    </div>
                                )}
                                {userProfile?.certifications && (
                                    <div class="info-item" style="margin-top: 1rem;">
                                        <span class="info-label">
                                            {t('profile.chungChi')}:
                                        </span>
                                        <ul class="bullet-list">
                                            {(() => {
                                                try {
                                                    const certifications = JSON.parse(
                                                        userProfile.certifications
                                                    );
                                                    return Array.isArray(
                                                        certifications
                                                    )
                                                        ? certifications
                                                        : [];
                                                } catch {
                                                    return [];
                                                }
                                            })().map(
                                                (certification: string) => (
                                                    <li>{certification}</li>
                                                )
                                            )}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>

                <!-- === CỘT PHẢI: CONTENT CHÍNH === -->
                <div class="right-content">
                    <!-- 1. Banner -->
                    <div class="banner-section">
                        <img
                            src={
                                userProfile?.portfolio_url ||
                                'https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=1600&auto=format&fit=crop'
                            }
                            alt="Cover"
                            class="banner-image"
                        />
                        <div class="banner-overlay">
                            <button class="btn-banner btn-share">
                                <i class="fa-solid fa-share-nodes"></i>
                                {t('profile.chiaSe')}
                            </button>
                            {isOwner && (
                                <a
                                    href={l('/edit-profile')}
                                    class="btn-banner btn-edit"
                                    style="text-decoration: none;"
                                >
                                    <i class="fa-solid fa-pen"></i>
                                    {t('profile.chinhSua')}
                                </a>
                            )}
                        </div>
                    </div>

                    <!-- 2. Mô tả -->
                    {userProfile?.bio && (
                        <div class="content-block">
                            <h3 class="content-title">{t('profile.moTa')} :</h3>
                            <p class="description-text">{userProfile.bio}</p>
                        </div>
                    )}

                    <!-- 3. Kỹ năng -->
                    {userSkills.length > 0 && (
                        <div class="content-block">
                            <h3 class="content-title">{t('profile.kiNang')} :</h3>
                            <div class="skills-wrapper">
                                {userSkills.map((skill) => (
                                    <span class="skill-tag">
                                        {skill.name}
                                        {skill.category
                                            ? ` / ${skill.category}`
                                            : ''}
                                    </span>
                                ))}
                            </div>
                        </div>
                    )}

                    <!-- 4. Dự án (Grid Card) -->
                    {userProjects.length > 0 && (
                        <div class="content-block">
                            <h3 class="content-title">{t('profile.duAn')} :</h3>
                            <div class="projects-row">
                                {userProjects.map((project) => (
                                    <a
                                        href={l(`/project/${project.id}`)}
                                        class="project-card-new"
                                    >
                                        <div class="project-thumb-wrapper">
                                            <img
                                                src={
                                                    project.cover_image_url ||
                                                    '/assets/images/vy2.png'
                                                }
                                                alt={project.title}
                                                class="project-thumb-new"
                                            />
                                        </div>
                                        <div class="project-info-new">
                                            <div class="project-header-row">
                                                <span class="project-title-new">
                                                    {project.title}
                                                </span>
                                                <span class="project-tag-badge">
                                                    {project.project_type || 'N/A'}
                                                </span>
                                            </div>
                                            <span class="project-email">
                                                {project.status || 'N/A'}
                                            </span>
                                        </div>
                                    </a>
                                ))}
                            </div>
                        </div>
                    )}

                    <!-- 5. Đánh giá (Carousel Tự động + Swipe) -->
                    {reviews.length > 0 && (
                        <div class="content-block">
                            <h3 class="content-title">{t('profile.danhGia')}:</h3>

                            <div class="reviews-container" id="reviews-container">
                                <div class="reviews-viewport">
                                    <div class="reviews-track" id="reviews-track">
                                        {reviews.map((review, index) => (
                                            <div
                                                class={`review-slide ${index === 0 ? 'active' : ''}`}
                                            >
                                                <div class="review-card-featured">
                                                    <img
                                                        src={
                                                            review.reviewer_info
                                                                ?.avatar_url ||
                                                            '/assets/images/vy2.png'
                                                        }
                                                        alt={
                                                            review.reviewer_info
                                                                ?.full_name ||
                                                            review.reviewer_info
                                                                ?.username ||
                                                            'Reviewer'
                                                        }
                                                        class="reviewer-avatar"
                                                    />
                                                    <div class="review-stars">
                                                        {Array(
                                                            review.rating || 0
                                                        )
                                                            .fill('★')
                                                            .join('')}
                                                    </div>
                                                    <p class="review-text">
                                                        "{review.comment ||
                                                            'Không có nhận xét'}"
                                                    </p>
                                                    <div class="reviewer-info">
                                                        <h5>
                                                            {review.reviewer_info
                                                                ?.full_name ||
                                                                review
                                                                    .reviewer_info
                                                                    ?.username ||
                                                                'Anonymous'}
                                                        </h5>
                                                        <span>
                                                            @
                                                            {review.reviewer_info
                                                                ?.username ||
                                                                'anonymous'}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <!-- Dots Navigation -->
                                <div class="review-dots" id="review-dots">
                                    {reviews.map((_, index) => (
                                        <span
                                            class={`dot ${index === 0 ? 'active' : ''}`}
                                            data-index={index}
                                        />
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        </main>
    </div>

    <!-- Import Script -->
    <script src="@/assets/script/personal-profile.js"></script>
</DefaultLayout>
