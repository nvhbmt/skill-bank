---
import DefaultLayout from '@/layouts/DefaultLayout.astro';
import '@/assets/css/edit-profile.css';
import Header from '@/components/Header.astro';
import { getStaticPaths, useTranslate } from '@/i18n';
import { supabase, createAuthenticatedClient } from '@/lib/supabase';
import type { Tables } from '@/types/database.types';
export { getStaticPaths };

const session = Astro.locals.session;
const { lang, t, l } = useTranslate(Astro);

if (!session?.user) return Astro.redirect(l(`/sign-in`));

let userInfo: Tables<'user_info'> | null = null;
let userProfile: any = null;
let userSkills: any[] = [];
let allSkills: any[] = [];
let userProjects: any[] = [];

try {
    const { data: userData, error: userError } = await supabase
        .from('user_info')
        .select('*')
        .eq('user_id', session.user.id)
        .is('deleted_at', null)
        .single();

    if (!userError && userData) {
        userInfo = userData;
        const { data: profileData } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('user_id', userInfo.user_id)
            .is('deleted_at', null)
            .maybeSingle();
        if (profileData) userProfile = profileData;

        const { data: userSkillsData } = await supabase
            .from('user_skills')
            .select('skill_id, level')
            .eq('user_id', userInfo.user_id)
            .is('deleted_at', null);

        if (userSkillsData?.length) {
            const skillIds = userSkillsData.map((us) => us.skill_id);
            const { data: skillsData } = await supabase
                .from('skills')
                .select('id, name, category')
                .in('id', skillIds);
            if (skillsData)
                userSkills = skillsData.map((skill) => ({
                    ...skill,
                    skill_id: skill.id,
                }));
        }

        const { data: allSkillsData } = await supabase
            .from('skills')
            .select('id, name, category')
            .order('name', { ascending: true });
        if (allSkillsData) allSkills = allSkillsData;

        const { data: projectsData } = await supabase
            .from('projects')
            .select('*')
            .eq('owner_id', userInfo.user_id)
            .is('deleted_at', null)
            .limit(5);
        if (projectsData) userProjects = projectsData;
    }
} catch (error) {
    console.error('Error loading profile:', error);
}

const safeJoin = (jsonVal: string | null | undefined) => {
    try {
        if (!jsonVal) return '';
        const parsed = JSON.parse(jsonVal);
        return Array.isArray(parsed) ? parsed.join('\n') : '';
    } catch (e) {
        return '';
    }
};

const educationText = safeJoin(userProfile?.interests);
const experienceText = safeJoin(userProfile?.experiences);
const achievementsText = safeJoin(userProfile?.projects);
const certificationsText = safeJoin(userProfile?.certifications);

const reviews = [
    {
        id: 1,
        name: 'Ly Huy',
        username: '@lyhuy2201',
        avatar: '/assets/images/vy2.png',
        rating: 5,
        text: 'Rất uy tín và linh hoạt.',
    },
    {
        id: 2,
        name: 'Nguyễn Văn A',
        username: '@nguyenvana',
        avatar: '/assets/images/vy2.png',
        rating: 5,
        text: 'Giao diện đẹp.',
    },
    {
        id: 3,
        name: 'Trần Thị B',
        username: '@tranthib',
        avatar: '/assets/images/vy2.png',
        rating: 4,
        text: 'Hoàn thành đúng hạn.',
    },
];
---

<DefaultLayout>
    <div class="wrapper">
        <Header />
        <main>
            <form
                method="POST"
                enctype="multipart/form-data"
                id="edit-profile-form"
            >
                <input
                    type="file"
                    id="avatar-upload"
                    name="avatar"
                    accept="image/*"
                    style="display: none;"
                />
                <input
                    type="file"
                    id="cover-image-upload"
                    name="cover_image"
                    accept="image/*"
                    style="display: none;"
                />
                <input
                    type="hidden"
                    name="delete_avatar"
                    id="delete-avatar-upload"
                    value="false"
                />
                <input
                    type="hidden"
                    name="delete_cover"
                    id="delete-cover-image-upload"
                    value="false"
                />

                <div class="edit-profile-container">
                    <!-- SIDEBAR -->
                    <div class="left-sidebar">
                        <div class="sidebar-card user-card">
                            <div class="user-avatar-wrapper">
                                <button
                                    type="button"
                                    id="remove-avatar-btn"
                                    class="btn-remove-image"
                                    title="Gỡ ảnh">×</button
                                >
                                <label for="avatar-upload" class="avatar-label">
                                    <img
                                        id="avatar-preview"
                                        src={userInfo?.avatar_url ||
                                            '/assets/images/default-avatar.png'}
                                        alt="Avatar"
                                        class="user-avatar"
                                    />
                                    <div class="avatar-overlay">
                                        <i
                                            class="fa-solid fa-camera"
                                            style="color: white; font-size: 2rem;"
                                        ></i>
                                    </div>
                                </label>
                            </div>
                            <div class="user-info-edit">
                                <input
                                    type="text"
                                    name="full_name"
                                    class="form-input"
                                    value={userInfo?.full_name || ''}
                                    placeholder="Họ và tên"
                                    style="text-align: center; font-weight: 700;"
                                />
                                <span
                                    style="color: var(--color-text-gray); font-size: 0.9rem;"
                                    >@{userInfo?.username}</span
                                >
                            </div>
                        </div>

                        <div class="sidebar-card section-card">
                            <h4>Thông tin chung</h4>
                            <div class="info-list">
                                <div class="form-group">
                                    <label class="form-label"
                                        >Số điện thoại</label
                                    ><input
                                        type="text"
                                        name="phone"
                                        class="form-input"
                                        value={userProfile?.phone || ''}
                                        placeholder="Nhập số điện thoại"
                                    />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label
                                    ><input
                                        type="text"
                                        class="form-input"
                                        value={userInfo?.email || ''}
                                        disabled
                                        style="opacity: 0.7; cursor: not-allowed;"
                                    />
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Địa chỉ</label
                                    ><input
                                        type="text"
                                        name="address"
                                        class="form-input"
                                        value={userProfile?.address || ''}
                                        placeholder="Nhập địa chỉ"
                                    />
                                </div>
                            </div>
                        </div>

                        <div class="sidebar-card section-card">
                            <h4>Thông tin thêm</h4>
                            <div class="info-list">
                                <div class="form-group">
                                    <label class="form-label"
                                        >Lĩnh vực quan tâm</label
                                    ><textarea
                                        name="interests"
                                        class="form-input"
                                        rows="4">{educationText}</textarea
                                    >
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Kinh nghiệm</label
                                    ><textarea
                                        name="experiences"
                                        class="form-input"
                                        rows="4">{experienceText}</textarea
                                    >
                                </div>
                            </div>
                        </div>

                        <div class="sidebar-card section-card">
                            <h4>Thành tựu</h4>
                            <div class="info-list">
                                <div class="form-group">
                                    <label class="form-label"
                                        >Dự án từng làm</label
                                    ><textarea
                                        name="projects"
                                        class="form-input"
                                        rows="4">{achievementsText}</textarea
                                    >
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Chứng chỉ</label
                                    ><textarea
                                        name="certifications"
                                        class="form-input"
                                        rows="4">{certificationsText}</textarea
                                    >
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CONTENT -->
                    <div class="right-content">
                        <div class="banner-section">
                            <button
                                type="button"
                                id="remove-cover-btn"
                                class="btn-remove-image"
                                title="Gỡ ảnh bìa">×</button
                            >
                            <img
                                id="cover-image-preview"
                                src={userProfile?.portfolio_url ||
                                    '/assets/images/background.png'}
                                alt="Cover"
                                class="banner-image"
                            />
                            <label
                                for="cover-image-upload"
                                class="banner-overlay-edit"
                            >
                                <div class="upload-text">
                                    <i class="fa-solid fa-image"></i><span
                                        >Thay đổi ảnh bìa</span
                                    >
                                </div>
                            </label>
                        </div>

                        <div class="content-block">
                            <h3 class="content-title">Mô tả :</h3>
                            <textarea
                                name="bio"
                                class="form-input"
                                rows="5"
                                placeholder="Giới thiệu..."
                                >{userProfile?.bio || ''}</textarea
                            >
                        </div>

                        <div class="content-block">
                            <h3 class="content-title">Kĩ năng :</h3>
                            <div
                                class="skills-edit-wrapper"
                                id="skills-container"
                            >
                                {
                                    userSkills.map((skill) => (
                                        <span
                                            class="skill-tag-edit"
                                            data-skill-id={skill.skill_id}
                                            data-skill-name={skill.name}
                                        >
                                            {skill.name}
                                            <input
                                                type="checkbox"
                                                name="skill_ids"
                                                value={skill.skill_id}
                                                checked
                                                style="display:none;"
                                            />
                                            <button
                                                type="button"
                                                class="remove-skill-btn"
                                            >
                                                ×
                                            </button>
                                        </span>
                                    ))
                                }
                            </div>
                            <div class="add-skill-controls">
                                <select
                                    id="new-skill-select"
                                    class="form-input skill-select"
                                >
                                    <option value="">Chọn kỹ năng...</option>
                                    {
                                        allSkills.map((skill) => (
                                            <option value={skill.id}>
                                                {skill.name}
                                            </option>
                                        ))
                                    }
                                </select>
                                <button
                                    type="button"
                                    id="add-skill-btn"
                                    class="btn-add-skill"
                                    ><i class="fa-solid fa-plus"></i> Thêm</button
                                >
                            </div>
                        </div>

                        <!-- PROJECTS (READ ONLY) -->
                        <div class="content-block">
                            <h3 class="content-title">Dự án của tôi :</h3>
                            {
                                userProjects.length > 0 ? (
                                    <div class="projects-row">
                                        {userProjects.map((proj) => (
                                            <a
                                                href={`/project/${proj.id}`}
                                                class="project-card-new"
                                                target="_blank"
                                            >
                                                <div class="project-thumb-wrapper">
                                                    <img
                                                        src={
                                                            proj.cover_image_url ||
                                                            '/assets/images/vy2.png'
                                                        }
                                                        alt={proj.title}
                                                        class="project-thumb-new"
                                                    />
                                                </div>
                                                <div class="project-info-new">
                                                    <div class="project-header-row">
                                                        <span class="project-title-new">
                                                            {proj.title}
                                                        </span>
                                                        <span class="project-tag-badge">
                                                            {proj.project_type}
                                                        </span>
                                                    </div>
                                                </div>
                                            </a>
                                        ))}
                                    </div>
                                ) : (
                                    <p style="color: #9ca3af;">
                                        Chưa có dự án.
                                    </p>
                                )
                            }
                        </div>

                        <!-- REVIEWS (READ ONLY) -->
                        <div class="content-block">
                            <h3 class="content-title">Đánh giá :</h3>
                            <div
                                class="reviews-container"
                                id="reviews-container"
                            >
                                <div class="reviews-viewport">
                                    <div
                                        class="reviews-track"
                                        id="reviews-track"
                                    >
                                        {
                                            reviews.map((review, index) => (
                                                <div
                                                    class={`review-slide ${index === 0 ? 'active' : ''}`}
                                                >
                                                    <div class="review-card-featured">
                                                        <img
                                                            src={review.avatar}
                                                            alt={review.name}
                                                            class="reviewer-avatar"
                                                        />
                                                        <div class="review-stars">
                                                            {Array(
                                                                review.rating
                                                            )
                                                                .fill('★')
                                                                .join('')}
                                                        </div>
                                                        <p class="review-text">
                                                            "{review.text}"
                                                        </p>
                                                        <div class="reviewer-info">
                                                            <>
                                                                <h5>
                                                                    {
                                                                        review.name
                                                                    }
                                                                </h5>
                                                                <span>
                                                                    {
                                                                        review.username
                                                                    }
                                                                </span>
                                                            </>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                                <div class="review-dots" id="review-dots">
                                    {
                                        reviews.map((_, index) => (
                                            <span
                                                class={`dot ${index === 0 ? 'active' : ''}`}
                                                data-index={index}
                                            />
                                        ))
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <a
                                href={l(`/profile/${userInfo?.username}`)}
                                class="btn btn-cancel">Hủy bỏ</a
                            >
                            <button type="submit" class="btn btn-save"
                                >Lưu thay đổi</button
                            >
                        </div>
                    </div>
                </div>
            </form>
        </main>
    </div>
    <script src="@/assets/script/edit-profile.js"></script>
</DefaultLayout>
