---
import DefaultLayout from '@/layouts/DefaultLayout.astro';
import Header from '@/components/Header.astro';
import '@/assets/css/my-project.css';
import { getStaticPaths, useTranslate } from '@/i18n';
export { getStaticPaths };

const session = Astro.locals.session;
const { lang, t, l } = useTranslate(Astro);

// Redirect if not logged in
if (!session?.user) {
    return Astro.redirect(`/${lang}/sign-in`);
}

// Type for project with members info
type ProjectWithMembers = {
    id: number;
    title: string;
    status: string | null;
    created_at: string | null;
    members: Array<{
        user_id: string;
        avatar_url: string | null;
    }>;
    progress: number;
};

// Initialize project arrays
let pendingProjects: ProjectWithMembers[] = [];
let approvedProjects: ProjectWithMembers[] = [];
let joinedProjects: ProjectWithMembers[] = [];
let completedProjects: ProjectWithMembers[] = [];

// Helper function to format date
function formatDate(dateString: string | null): string {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('vi-VN', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
        });
    } catch {
        return dateString;
    }
}

// Fetch projects from API
try {
    const response = await fetch('/api/projects/my-projects', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    });

    if (response.ok) {
        const result = await response.json();
        if (result.success && result.data) {
            pendingProjects = result.data.pending || [];
            approvedProjects = result.data.approved || [];
            joinedProjects = result.data.joined || [];
            completedProjects = result.data.completed || [];
        }
    } else {
        console.error('Error fetching projects:', response.statusText);
    }
} catch (error) {
    console.error('Error loading projects:', error);
}
---

<DefaultLayout>
    <div class="wrapper">
        <Header />

        <main>
            <div class="my-projects-container">
                <!-- Header -->
                <div class="page-header">
                    <h1 class="page-title">{t('my-project.title')}</h1>
                    <p class="page-subtitle">{t('my-project.description')}</p>
                </div>

                <!-- Tabs Navigation -->
                <div class="tabs-container">
                    <button class="tab-btn active" data-tab="pending"
                        >{t('my-project.choDuyet')}</button
                    >
                    <button class="tab-btn" data-tab="approved"
                        >{t('my-project.daDuyet')}</button
                    >
                    <button class="tab-btn" data-tab="joined"
                        >{t('my-project.thamGia')}</button
                    >
                    <button class="tab-btn" data-tab="completed"
                        >{t('my-project.hoanThanh')}</button
                    >
                </div>

                <!-- CONTENT TAB 1: DỰ ÁN CHỜ DUYỆT -->
                <div id="pending" class="projects-grid tab-content">
                    {
                        pendingProjects.length > 0 ? (
                            pendingProjects.map((project) => {
                                const visibleMembers = project.members.slice(
                                    0,
                                    3
                                );
                                const remainingCount =
                                    project.members.length - 3;
                                return (
                                    <a
                                        href={l(`/project/${project.id}`)}
                                        class="project-card"
                                    >
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                {project.title}
                                            </h3>
                                            <div class="card-info-row">
                                                <div class="member-avatars">
                                                    {visibleMembers.map(
                                                        (member) => (
                                                            <img
                                                                src={
                                                                    member.avatar_url ||
                                                                    '/assets/images/vy2.png'
                                                                }
                                                                alt="Member"
                                                                class="avatar-img"
                                                            />
                                                        )
                                                    )}
                                                    {remainingCount > 0 && (
                                                        <div class="avatar-more">
                                                            +{remainingCount}
                                                        </div>
                                                    )}
                                                </div>
                                                <span class="project-date">
                                                    {formatDate(
                                                        project.created_at
                                                    )}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="card-status-row">
                                            <span class="status-label">
                                                {t('my-project.trangThai')}
                                            </span>
                                            <span class="status-indicator status-orange" />
                                        </div>
                                        <div class="card-progress-row">
                                            <span class="progress-label">
                                                {t('my-project.tienTrinh')}
                                            </span>
                                            <div class="progress-track">
                                                <div
                                                    class="progress-fill"
                                                    style={`width: ${project.progress}%`}
                                                />
                                            </div>
                                            <span class="progress-text">
                                                {project.progress}%
                                            </span>
                                        </div>
                                    </a>
                                );
                            })
                        ) : (
                            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--color-text-gray);">
                                Không có dự án nào
                            </div>
                        )
                    }
                </div>

                <!-- CONTENT TAB 2: DỰ ÁN ĐÃ DUYỆT -->
                <div
                    id="approved"
                    class="projects-grid tab-content"
                    style="display: none;"
                >
                    {
                        approvedProjects.length > 0 ? (
                            approvedProjects.map((project) => {
                                const visibleMembers = project.members.slice(
                                    0,
                                    3
                                );
                                const remainingCount =
                                    project.members.length - 3;
                                return (
                                    <a
                                        href={l(`/project/${project.id}`)}
                                        class="project-card"
                                    >
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                {project.title}
                                            </h3>
                                            <div class="card-info-row">
                                                <div class="member-avatars">
                                                    {visibleMembers.map(
                                                        (member) => (
                                                            <img
                                                                src={
                                                                    member.avatar_url ||
                                                                    '/assets/images/vy2.png'
                                                                }
                                                                alt="Member"
                                                                class="avatar-img"
                                                            />
                                                        )
                                                    )}
                                                    {remainingCount > 0 && (
                                                        <div class="avatar-more">
                                                            +{remainingCount}
                                                        </div>
                                                    )}
                                                </div>
                                                <span class="project-date">
                                                    {formatDate(
                                                        project.created_at
                                                    )}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="card-status-row">
                                            <span class="status-label">
                                                {t('my-project.trangThai')}
                                            </span>
                                            <span class="status-indicator status-green" />
                                        </div>
                                        <div class="card-progress-row">
                                            <span class="progress-label">
                                                {t('my-project.tienTrinh')}
                                            </span>
                                            <div class="progress-track">
                                                <div
                                                    class="progress-fill"
                                                    style={`width: ${project.progress}%`}
                                                />
                                            </div>
                                            <span class="progress-text">
                                                {project.progress}%
                                            </span>
                                        </div>
                                    </a>
                                );
                            })
                        ) : (
                            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--color-text-gray);">
                                Không có dự án nào
                            </div>
                        )
                    }
                </div>

                <!-- CONTENT TAB 3: DỰ ÁN ĐÃ THAM GIA -->
                <div
                    id="joined"
                    class="projects-grid tab-content"
                    style="display: none;"
                >
                    {
                        joinedProjects.length > 0 ? (
                            joinedProjects.map((project) => {
                                const visibleMembers = project.members.slice(
                                    0,
                                    3
                                );
                                const remainingCount =
                                    project.members.length - 3;
                                return (
                                    <a
                                        href={l(`/project/${project.id}`)}
                                        class="project-card"
                                    >
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                {project.title}
                                            </h3>
                                            <div class="card-info-row">
                                                <div class="member-avatars">
                                                    {visibleMembers.map(
                                                        (member) => (
                                                            <img
                                                                src={
                                                                    member.avatar_url ||
                                                                    '/assets/images/vy2.png'
                                                                }
                                                                alt="Member"
                                                                class="avatar-img"
                                                            />
                                                        )
                                                    )}
                                                    {remainingCount > 0 && (
                                                        <div class="avatar-more">
                                                            +{remainingCount}
                                                        </div>
                                                    )}
                                                </div>
                                                <span class="project-date">
                                                    {formatDate(
                                                        project.created_at
                                                    )}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="card-status-row">
                                            <span class="status-label">
                                                {t('my-project.trangThai')}
                                            </span>
                                            <span class="status-indicator status-green" />
                                        </div>
                                        <div class="card-progress-row">
                                            <span class="progress-label">
                                                {t('my-project.tienTrinh')}
                                            </span>
                                            <div class="progress-track">
                                                <div
                                                    class="progress-fill"
                                                    style={`width: ${project.progress}%`}
                                                />
                                            </div>
                                            <span class="progress-text">
                                                {project.progress}%
                                            </span>
                                        </div>
                                    </a>
                                );
                            })
                        ) : (
                            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--color-text-gray);">
                                Không có dự án nào
                            </div>
                        )
                    }
                </div>

                <!-- CONTENT TAB 4: DỰ ÁN HOÀN THÀNH -->
                <div
                    id="completed"
                    class="projects-grid tab-content"
                    style="display: none;"
                >
                    {
                        completedProjects.length > 0 ? (
                            completedProjects.map((project) => {
                                const visibleMembers = project.members.slice(
                                    0,
                                    3
                                );
                                const remainingCount =
                                    project.members.length - 3;
                                return (
                                    <a
                                        href={l(`/project/${project.id}`)}
                                        class="project-card"
                                    >
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                {project.title}
                                            </h3>
                                            <div class="card-info-row">
                                                <div class="member-avatars">
                                                    {visibleMembers.map(
                                                        (member) => (
                                                            <img
                                                                src={
                                                                    member.avatar_url ||
                                                                    '/assets/images/vy2.png'
                                                                }
                                                                alt="Member"
                                                                class="avatar-img"
                                                            />
                                                        )
                                                    )}
                                                    {remainingCount > 0 && (
                                                        <div class="avatar-more">
                                                            +{remainingCount}
                                                        </div>
                                                    )}
                                                </div>
                                                <span class="project-date">
                                                    {formatDate(
                                                        project.created_at
                                                    )}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="card-status-row">
                                            <span class="status-label">
                                                {t('my-project.trangThai')}
                                            </span>
                                            <span class="status-indicator status-blue" />
                                        </div>
                                        <div class="card-progress-row">
                                            <span class="progress-label">
                                                {t('my-project.tienTrinh')}
                                            </span>
                                            <div class="progress-track">
                                                <div
                                                    class="progress-fill"
                                                    style="width: 100%"
                                                />
                                            </div>
                                            <span class="progress-text">
                                                100%
                                            </span>
                                        </div>
                                    </a>
                                );
                            })
                        ) : (
                            <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--color-text-gray);">
                                Không có dự án nào
                            </div>
                        )
                    }
                </div>
            </div>
        </main>
    </div>

    <script src="@/assets/script/my-project.js"></script>
</DefaultLayout>
