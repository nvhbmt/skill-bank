---
import '@/assets/css/project-search.css';
import Header from '@/components/Header.astro';
import { getStaticPaths, useTranslate } from '@/i18n';
import DefaultLayout from '@/layouts/DefaultLayout.astro';
import { supabase } from '@/lib/supabase';
import type { Tables } from '@/types/database.types';
export { getStaticPaths };

const { lang, t, l } = useTranslate(Astro);

// Load initial projects from database using types from database.types.ts
let projects: Array<
    Pick<
        Tables<'projects'>,
        | 'id'
        | 'title'
        | 'description'
        | 'cover_image_url'
        | 'project_type'
        | 'location'
        | 'start_date'
        | 'status'
        | 'created_at'
        | 'owner_id'
    > & {
        user_info: Pick<
            Tables<'user_info'>,
            'user_id' | 'email' | 'full_name' | 'username' | 'avatar_url'
        > | null;
    }
> = [];

try {
    const { data, error } = await supabase
        .from('projects')
        .select(
            `
            id,
            title,
            description,
            cover_image_url,
            project_type,
            location,
            start_date,
            status,
            created_at,
            owner_id
        `
        )
        .is('deleted_at', null)
        .neq('status', 'pending')
        .order('created_at', { ascending: false })
        .limit(20);

    if (!error && data) {
        // Load owner info separately
        const ownerIds = [...new Set(data.map((p) => p.owner_id))];
        const { data: ownersData } = await supabase
            .from('user_info')
            .select('user_id, email, full_name, username, avatar_url')
            .in('user_id', ownerIds);

        const ownersMap = new Map(
            (ownersData || []).map((owner) => [owner.user_id, owner])
        );

        projects = data.map((project) => ({
            ...project,
            user_info: ownersMap.get(project.owner_id) || null,
        }));
    } else {
        console.error('Error loading projects:', error);
    }
} catch (error) {
    console.error('Error loading projects:', error);
}
---

<DefaultLayout>
    <Header />
    <div class="container">
        <div class="title">
            <h1>{t('project-search.title')}</h1>
        </div>
        <div class="search-container">
            <div class="search-bar">
                <div class="icon-search">
                    <img src="/assets/images/Icon-search.svg" alt="" />
                </div>
                <input
                    type="text"
                    id="searchInput"
                    placeholder={t('project-search.enterKeywords')}
                />
            </div>
        </div>
        <div class="content">
            <div class="project">
                <div class="project-container" id="projects-container">
                    {
                        projects.length > 0 ? (
                            projects.map((project) => {
                                const owner = project.user_info;
                                const projectTypeLabel =
                                    project.project_type === 'website'
                                        ? 'Website'
                                        : project.project_type === 'mobile-app'
                                          ? 'Mobile App'
                                          : project.project_type ===
                                              'desktop-app'
                                            ? 'Desktop App'
                                            : project.project_type || '';

                                return (
                                    <div
                                        class="project-image"
                                        data-project-id={project.id}
                                    >
                                        <img
                                            loading="lazy"
                                            class="project-image-img"
                                            src={
                                                project.cover_image_url ||
                                                '/assets/images/project-image.svg'
                                            }
                                            alt={project.title}
                                        />
                                        <div class="project-content">
                                            <div class="left-project-content">
                                                <div class="design-web">
                                                    {project.title}
                                                </div>
                                                <div class="email-address">
                                                    {owner?.email || 'N/A'}
                                                </div>
                                            </div>
                                            <div class="right-project-content">
                                                <div class="interact">
                                                    <div class="eyes">
                                                        <img
                                                            src="/assets/images/teenyicons_eye-outline.svg"
                                                            alt=""
                                                        />
                                                        <span class="view-count">
                                                            0
                                                        </span>
                                                    </div>
                                                    <div class="like">
                                                        <img
                                                            src="/assets/images/solar_like-outline.svg"
                                                            alt=""
                                                        />
                                                        <span class="like-count">
                                                            0
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="view-more">
                                                    {t(
                                                        'project-search.viewMore'
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })
                        ) : (
                            <div class="no-projects">
                                <p>Không có dự án nào</p>
                            </div>
                        )
                    }
                </div>
            </div>
        </div>
    </div>
    <script src="@/assets/script/project-search.js"></script>
</DefaultLayout>
